/*
    Automatically generated by Fault
    Do not modify.
    Generated on: 2020-06-02 10:34:50
*/
`include "Tech/osu035/osu035_stdcells.v"
`include "Netlists/s27.netlist.v.chained.v.jtag.v.intermediate.v"

module testbench;
    reg[0:0] \G3 ;
    reg[0:0] \G2 ;
    wire[0:0] \tdo ;
    wire[0:0] \G17 ;
    reg[0:0] \tdi ;
    reg[0:0] \tck ;
    reg[0:0] \G0 ;
    reg[0:0] \CK ;
    reg[0:0] \trst ;
    reg[0:0] \reset ;
    reg[0:0] \tms ;
    reg[0:0] \G1 ;
    reg[0:0] \VDD ;
    reg[0:0] \GND ;

    
    always #1 CK = ~CK;
    always #1 tck = ~tck;

    s27 uut(
        .\G3 ( \G3 ) , .\G2 ( \G2 ) , .\tdo ( \tdo ) , .\G17 ( \G17 ) , .\tdi ( \tdi ) , .\tck ( \tck ) , .\G0 ( \G0 ) , .\CK ( \CK ) , .\trst ( \trst ) , .\reset ( \reset ) , .\tms ( \tms ) , .\G1 ( \G1 ) , .\VDD ( \VDD ) , .\GND ( \GND ) 
    );

    integer i;
    reg [6: 0] stores;
    reg[7:0] tmsPattern = 8'b 01100110;

    wire[3:0] extest = 4'b 0000;
    wire[3:0] samplePreload = 4'b 0001;
    wire[3:0] bypass = 4'b 1111;
    wire[3:0] scanIn = 4'b 0100;

    reg[6:0] serializable =
        7'b1111100;
    wire [6: 0] boundarySerial = 
        7'b1100110;
   
    reg[6:0] serial;
    
    wire [2: 0] scanInSerializable = 
        3'b001;
    reg[2:0] scanInSerial;

    initial begin
        $dumpfile("dut.vcd"); // DEBUG
        $dumpvars(0, testbench);
        \GND = 0 ;
        \VDD = 0 ;
        \CK = 0 ;
        \reset = 1 ;
        \G0 = 0 ;
        \G1 = 0 ;
        \G2 = 0 ;
        \G3 = 0 ;
        \tms = 1 ;
        \tck = 0 ;
        \tdi = 0 ;
        \trst = 0 ;

        #10;
        reset = ~reset;
        trst = 1;        
        #2;
        /*
            Test Sample/Preload Instruction
        */
        shiftIR(samplePreload);

        // SAMPLE
        tms = 1;     // select-DR 
        #2;
        tms = 0;     // capture-DR 
        \GND = 1 ;
        \VDD = 1 ;
        \G0 = 1 ;
        \G1 = 1 ;
        \G2 = 1 ;
        \G3 = 0 ;

        #2;
        tms = 0;     // shift-DR 
        #2;
        serializable[0] = G17 ; 

        #2;
        for (i = 0; i < 7; i = i + 1) begin
            tms = 0;
            serial[i] = tdo; 
            #2;
        end
        if(serial != serializable) begin
            $error("EXECUTING_SAMPLE_INST_FAILED");
            $finish;
        end
        #100;
        
        exitDR();

        // PRELOAD
        enterShiftDR();
        for (i = 0; i < 7; i = i + 1) begin
            tdi = boundarySerial[i];
            if(i == 6) begin
                exitDR();
            end
            #2;
        end
        
        stores[0] = uut.__dut__.\__BoundaryScanRegister_input_0__.store ;
        stores[1] = uut.__dut__.\__BoundaryScanRegister_input_1__.store ;
        stores[2] = uut.__dut__.\__BoundaryScanRegister_input_2__.store ;
        stores[3] = uut.__dut__.\__BoundaryScanRegister_input_3__.store ;
        stores[4] = uut.__dut__.\__BoundaryScanRegister_input_4__.store ;
        stores[5] = uut.__dut__.\__BoundaryScanRegister_input_5__.store ;
        stores[6] = uut.__dut__.\__BoundaryScanRegister_output_6__.store ;

        for(i = 0; i< 7; i = i + 1) begin
            if(stores[i] != boundarySerial[i + 6]) begin
                $error("EXECUTING_PRELOAD_INST_FAILED");
                $finish;
            end
        end 
        /*
            Test SCAN IN Instruction
        */
        shiftIR(scanIn);
        
        enterShiftDR();
        for (i = 0; i < 3; i = i + 1) begin
            tdi = scanInSerializable[i];
            #2;
        end

        for (i = 0; i < 3; i = i + 1) begin
            scanInSerial[i] = tdo;
            if(i == 2) begin
               exitDR();
            end
            #2;
        end
        if(scanInSerial != scanInSerializable) begin
            $error("EXECUTING_SCANIN_INST_FAILED");
            $finish;
        end
        /*
            Test BYPASS Instruction 
        */
        shiftIR(bypass);

        enterShiftDR();
        for (i = 0; i < 10; i = i + 1) begin
            tdi = 1;
            #3;
            if (tdo != 1) begin
                $error("ERROR_EXECUTING_BYPASS_INST");
            end
            if(i == 9) begin
               exitDR();
            end
        end
        
        $display("SUCCESS_STRING");
        $finish;
    end

    task shiftIR;
    input[3:0] instruction;
    integer i;
        begin
            $display("INSIDE TASK");
            for (i = 0; i< 5; i = i + 1) begin
                tms = tmsPattern[i];
                #2;
            end

            // At shift-IR: shift new instruction on tdi line
            for (i = 0; i < 4; i = i + 1) begin
                tdi = instruction[i];
                if(i == 3) begin
                    tms = tmsPattern[5];     // exit-ir
                end
                #2;
            end

            tms = tmsPattern[6];     // update-ir 
            #2;
            tms = tmsPattern[7];     // run test-idle
            #6;
        end
    endtask
    
    task enterShiftDR;
        begin
            tms = 1;     // select DR
            #2;
            tms = 0;     // capture DR -- shift DR
            #4;
        end
    endtask

    task exitDR;
        begin
            tms = 1;     // Exit DR -- update DR
            #4;
            tms = 0;     // Run test-idle
            #2;
        end
    endtask

endmodule
